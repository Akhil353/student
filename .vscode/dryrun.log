make --dry-run --always-make --keep-going --print-directory
make: Entering directory `/Users/Akhil/vscode/student'
echo "Stopping server..."
# kills process running on port 4200
 
lsof -ti :4200 | xargs kill >/dev/null 2>&1 || true
echo "Stopping logging process..."
# kills previously running logging processes
ps aux | awk -v log_file=/tmp/jekyll4200.log '$0 ~ "tail -f " log_file { print $2 }' | xargs kill >/dev/null 2>&1 || true
# removes log
rm -f /tmp/jekyll4200.log
echo "Starting server..."
nohup bundle exec jekyll serve -H 127.0.0.1 -P 4200 > /tmp/jekyll4200.log 2>&1 & \
		PID=$!; \
		echo "Server PID: $PID"
until [ -f /tmp/jekyll4200.log ]; do sleep 1; done
echo "Terminal logging starting, watching server..."
# tail and awk work together to extract Jekyll regeneration messages
# When a _notebook is detected in the log, call make convert in the background
# Note: We use the "if ($0 ~ /_notebooks\/.*\.ipynb/) { system(\"make convert &\") }" to call make convert
(tail -f /tmp/jekyll4200.log | awk '/Server address: http:\/\/127.0.0.1:4200\/student\// { serverReady=1 } \
	serverReady && /^ *Regenerating:/ { regenerate=1 } \
	regenerate { \
		if (/^[[:blank:]]*$/) { regenerate=0 } \
		else { \
			print; \
			if ($0 ~ /_notebooks\/.*\.ipynb/) { system("make convert &") } \
		} \
	}') 2>/dev/null &
# start an infinite loop with timeout to check log status
for ((COUNTER = 0; ; COUNTER++)); do \
		if grep -q "Server address:" /tmp/jekyll4200.log; then \
			echo "Server started in $COUNTER seconds"; \
			break; \
		fi; \
		if [ $COUNTER -eq 60 ]; then \
			echo "Server timed out after $COUNTER seconds."; \
			echo "Review errors from /tmp/jekyll4200.log."; \
			cat /tmp/jekyll4200.log; \
			exit 1; \
		fi; \
		sleep 1; \
	done
# outputs startup log, removes last line ($d) as ctl-c message is not applicable for background process
sed '$d' /tmp/jekyll4200.log
make: Leaving directory `/Users/Akhil/vscode/student'
 
